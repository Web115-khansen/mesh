var multiple_content_sections=multiple_content_sections||{};multiple_content_sections.blocks=function(a){var b,c,d=a("body");return{init:function(){b=multiple_content_sections.blocks,c=multiple_content_sections.admin,d.on("click",".mcs-block-featured-image-trash",b.remove_background).on("click",".mcs-block-featured-image-choose",b.choose_background).on("click.OpenMediaManager",".mcs-block-featured-image-choose",b.choose_background).on("click",".msc-title-editor:not(.title-input-visible)",b.show_title_input).on("blur","input.mcs-section-title",b.hide_title_input).on("click",".close-title-edit",b.hide_title_input),b.setup_resize_slider(),b.setup_drag_drop()},setup_drag_drop:function(){a(".mcs-editor-blocks .block").draggable({appendTo:"body",helper:function(b){var c=a(this),d=c.width();return $clone=c.clone().width(d).css("background","#fff"),$clone.find("*").removeAttr("id"),$clone},revert:!0,zIndex:1e3,handle:".mcs-row-title",iframeFix:!0,start:function(a,b,c){}}),a(".block").addClass("ui-widget ui-widget-content ui-helper-clearfix").find(".block-header").addClass("hndle ui-sortable-handle").prepend("<span class='block-toggle' />"),a(".drop-target").droppable({accept:".block:not(.ui-sortable-helper)",activeClass:"ui-state-hover",hoverClass:"ui-state-active",handle:".block-header",revert:!0,drop:function(c,d){var e=a(this),f=d.draggable,g=d.draggable.parent(),h=a(c.target),i=h.find(".block"),j=h.parents(".multiple-content-sections-section"),k=j.attr("data-mcs-section-id");return f.css({top:"",left:""}),e.append(f),g.append(i),b.reorder_blocks(j.find(".wp-editor-area")),b.save_order(k,c,d),b.setup_drag_drop(),!1}})},change_block_widths:function(b,c){var d=a(b.target),e=d.parent().parent().parent().find(".mcs-editor-blocks").find(".columns").addClass("dragging"),f=e.length,g=12,h=c.value,i=12,j=3,k=0,l=0,m=[];2==f?(i=9,j=3,h=Math.max(j,h),h=Math.min(i,h),m=[h,g-h]):3==f&&("undefined"!=typeof c.value&&(k=h&&2>f?h:c.values[0],l=c.values[1]),i=6,j=3,m=[],h=Math.max(j,k),h=Math.min(i,h),m[0]=h,j=k+3,i=9,h=Math.max(j,l),h=Math.min(i,h),m[1]=h-m[0],m[2]=g-(m[0]+m[1])),e.removeClass(function(a,b){return(b.match(/\mcs-columns-\d+/g)||[]).join(" ")}).each(function(b){a(this).addClass("mcs-columns-"+m[b])})},save_block_widths:function(b,c){var d=a(b.target),e=d.parent().parent().parent().find(".mcs-editor-blocks").find(".columns"),f=e.length,g=12,h=d.slider("value"),i={post_id:parseInt(mcs_data.post_id),section_id:parseInt(d.closest(".multiple-content-sections-section").attr("data-mcs-section-id")),blocks:{}},j=12,k=3,l=h&&2>f?h:d.slider("values",0),m=d.slider("values",1),n=[];return 2==f&&(j=9,k=3,h=Math.max(k,h),h=Math.min(j,h),h!=d.slider("value")&&d.slider("value",h),n=[h,g-h]),3==f&&(j=6,k=3,n=[],h=Math.max(k,l),h=Math.min(j,h),n[0]=h,k=l+3,j=9,h=Math.max(k,m),h=Math.min(j,h),n[1]=h-n[0],n[2]=g-(n[0]+n[1]),n[0]!=d.slider("option","values")[0]||h!=d.slider("option","values")[1])?void d.slider("option","values",[h[0],h]).refresh():(e.removeClass(function(a,b){return(b.match(/\mcs-columns-\d+/g)||[]).join(" ")}),e.each(function(b){var c=a(this),d=parseInt(c.find(".block").attr("data-mcs-block-id")),e=c.find(".column-width"),f=c.find(".column-width-indicator");c.addClass("mcs-columns-"+n[b]),d&&n[b]&&(e.val(n[b]),f.text(n[b]),i.blocks[d.toString()]=n[b])}),void a.post(ajaxurl,{action:"mcs_update_block_widths",mcs_post_data:i,mcs_reorder_blocks_nonce:mcs_data.reorder_blocks_nonce},function(a){}))},setup_resize_slider:function(){a(".column-slider").addClass("ui-slider-horizontal").each(function(){var c=a(this),d=parseInt(c.attr("data-mcs-blocks")),e=d>2,f=a.parseJSON(c.attr("data-mcs-columns")),g={range:e,min:0,max:12,step:1,start:function(){c.css("z-index",1e3)},stop:function(){c.css("z-index","").find(".ui-slider-handle").css("z-index",1e3)},change:b.save_block_widths,slide:b.change_block_widths};f&&(g.value=f[0]),3===d&&(f[1]=f[0]+f[1],f.pop(),g.values=f,g.value=null),c.slider(g)})},reorder_blocks:function(b){b.each(function(){var b,c=a(this).prop("id"),d=[],e=[];if("undefined"!=typeof tinymce.editors&&tinymce.editors[c]&&tinymce.get(c).remove(),"undefined"!=typeof tinymce){var f=a(this).closest(".block-content");if("undefined"==typeof tinyMCEPreInit.mceInit[c]){if(b="content",f.html(a(this).closest(".block-content").html().replace(new RegExp(b,"g"),c)),!b||"undefined"==typeof tinyMCEPreInit.mceInit[b])return;d=a.extend(!0,{},tinyMCEPreInit.mceInit[b]),d.body_class=d.body_class.replace(b,c),d.selector=d.selector.replace(b,c),d.wp_skip_init=!1,tinyMCEPreInit.mceInit[c]=d,b&&"undefined"!=typeof tinyMCEPreInit.qtInit[b]&&(e=a.extend(!0,{},tinyMCEPreInit.qtInit[b]),e.id=e.id.replace(b,c),tinyMCEPreInit.qtInit[c]=e,"undefined"!=typeof quicktags&&quicktags(tinyMCEPreInit.qtInit[c]))}f.find(".switch-tmce").trigger("click")}})},save_order:function(c,d,e){var f=a(".mcs-reorder-spinner"),g=[];a("#mcs-sections-editor-"+c).find(".block").each(function(){g.push(a(this).attr("data-mcs-block-id"))});b.save_ajax(c,g,f)},save_ajax:function(b,c,d){a.post(ajaxurl,{action:"mcs_update_block_order",mcs_section_id:b,mcs_blocks_ids:c,mcs_reorder_blocks_nonce:mcs_data.reorder_blocks_nonce},function(a){})},choose_background:function(b){b.preventDefault(),b.stopPropagation();var d=a(this),e=d.parents(".block"),f=parseInt(e.attr("data-mcs-block-id")),g="mcs-background-select-"+f,h=d.attr("data-mcs-block-featured-image");return c.media_frames=c.media_frames||[],c.media_frames[g]?(c.media_frames[g].uploader.uploader.param("mcs_upload","true"),void c.media_frames[g].open()):(c.media_frames[g]=wp.media.frames.media_frames=wp.media({className:"media-frame mcs-media-frame",frame:"select",multiple:!1,title:mcs_data.strings.select_block_bg,button:{text:mcs_data.strings.select_bg}}),c.media_frames[g].on("open",function(){var a=c.media_frames[g].state().get("selection");a.add(wp.media.attachment(h))}),c.media_frames[g].on("select",function(){var b=c.media_frames[g].state().get("selection").first().toJSON(),e=a("<span />",{"class":"dashicons dashicons-edit"}),i=a("<span />",{"class":"dashicons dashicons-trash"}),j=a("<button/>",{type:"button","data-mcs-section-featured-image":"",href:"#","class":"mcs-featured-image-trash"}).text(mcs_data.strings.remove_image).prepend(i);a.post(ajaxurl,{action:"mcs_update_featured_image",mcs_section_id:parseInt(f),mcs_image_id:parseInt(b.id),mcs_featured_image_nonce:mcs_data.featured_image_nonce},function(a){-1!=a&&(h=b.id,d.text(b.title).attr("data-mcs-section-featured-image",parseInt(b.id)).append(e).after(j))})}),void c.media_frames[g].open())},remove_background:function(b){b.preventDefault(),b.stopPropagation();var c=a(this),d=c.parents(".block"),e=parseInt(d.attr("data-mcs-block-id")),f=a('<span class="dashicons dashicons-format-image" />');a.post(ajaxurl,{action:"mcs_update_featured_image",mcs_section_id:parseInt(e),mcs_featured_image_nonce:mcs_data.featured_image_nonce},function(a){-1!=a&&(c.prev().text(mcs_data.strings.add_image).prepend(f),c.remove())})},show_title_input:function(b){b.preventDefault(),b.stopPropagation(),a(this).addClass("title-input-visible")},hide_title_input:function(b){b.preventDefault(),b.stopPropagation(),a(".title-input-visible").removeClass("title-input-visible")}}}(jQuery),multiple_content_sections=multiple_content_sections||{},multiple_content_sections.admin=function(a){var b,c,d,e=a("body"),f=a(".mcs-section-reorder"),g=a(".mcs-section-add"),h=a(".mcs-section-expand"),i=a("#mcs-container"),j=a("#multiple-content-sections-container"),k=a("#mcs-description"),l=[];return{init:function(){c=multiple_content_sections.admin,d=multiple_content_sections.blocks,e.on("click",".mcs-section-add",c.add_section).on("click",".mcs-section-remove",c.remove_section).on("click",".mcs-section-reorder",c.reorder_sections).on("click",".mcs-save-order",c.save_section_order).on("click",".mcs-featured-image-trash",c.remove_background).on("click",".mcs-section-expand",c.expand_all_sections).on("click",".mcs-featured-image-choose",c.choose_background).on("click.OpenMediaManager",".mcs-featured-image-choose",c.choose_background).on("change",".mcs-choose-layout",c.choose_layout).on("keyup",".mcs-section-title",c.change_section_title),b=a(".multiple-content-sections-section"),b.length<=1&&f.addClass("disabled"),d.init(),c.setup_notifications(i)},setup_notifications:function(b){b.find(".notice.is-dismissible").each(function(){var b=a(this),c=a('<button type="button" class="notice-dismiss"><span class="screen-reader-text"></span></button>'),d=commonL10n.dismiss||"";c.find(".screen-reader-text").text(d),b.append(c),c.on("click.wp-dismiss-notice",function(c){c.preventDefault(),a.post(ajaxurl,{action:"mcs_dismiss_notification",mcs_notification_type:b.attr("data-type"),_wpnonce:mcs_data.dismiss_nonce},function(a){}),b.fadeTo(100,0,function(){a(this).slideUp(100,function(){a(this).remove()})})})})},expand_all_sections:function(b){b.preventDefault(),b.stopPropagation();var c=a(this);c.toggleClass("expanded"),c.hasClass("expanded")?c.text(mcs_data.strings.collapse_all):c.text(mcs_data.strings.expand_all),a("#multiple-content-sections-container").find(".hndle").trigger("click")},choose_layout:function(b){b.preventDefault(),b.stopPropagation();var e=a(this),f=e.siblings(".spinner"),g=e.parents(".multiple-content-sections-section"),h=g.attr("data-mcs-section-id");return e.hasClass("disabled")?!1:(f.addClass("is-active"),void a.post(ajaxurl,{action:"mcs_choose_layout",mcs_post_id:mcs_data.post_id,mcs_section_id:h,mcs_section_layout:a(this).val(),mcs_choose_layout_nonce:mcs_data.choose_layout_nonce},function(b){if(b){var e=a(b),g=e.find(".wp-editor-area"),i=a("#mcs-sections-editor-"+h);i.html("").append(e),d.reorder_blocks(g),d.setup_resize_slider(),d.setup_drag_drop(),c.setup_notifications(i),f.removeClass("is-active")}else f.removeClass("is-active")}))},add_section:function(b){b.preventDefault(),b.stopPropagation();var c=a(this),e=c.siblings(".spinner");return c.hasClass("disabled")?!1:(e.addClass("is-active"),void a.post(ajaxurl,{action:"mcs_add_section",mcs_post_id:mcs_data.post_id,mcs_add_section_nonce:mcs_data.add_section_nonce},function(b){if(b){var c=a(b),g=c.find(".wp-editor-area"),h=a(".empty-sections-message");j.append(c),e.removeClass("is-active"),h.length&&h.fadeOut("fast");var k=a(".multiple-content-sections-section",i);k.length>1&&f.removeClass("disabled"),d.reorder_blocks(g)}else e.removeClass("is-active")}))},remove_section:function(b){b.preventDefault(),b.stopPropagation();var c=a(this),d=c.parents(".multiple-content-sections-postbox"),e=a(".mcs-add-spinner",d),g=d.attr("data-mcs-section-id");e.addClass("is-active"),a.post(ajaxurl,{action:"mcs_remove_section",mcs_post_id:mcs_data.post_id,mcs_section_id:g,mcs_remove_section_nonce:mcs_data.remove_section_nonce},function(b){"1"===b?d.fadeOut(400,function(){d.remove();var b=a(".multiple-content-sections-section",i);b.length<=1&&f.addClass("disabled")}):e.removeClass("is-active")})},reorder_sections:function(b){b.preventDefault(),b.stopPropagation();var d=a(this),e=(d.siblings(".spinner"),a(".multiple-content-sections-postbox",j)),f=a('<span class="mcs-block-click">');h.addClass("disabled"),g.addClass("disabled"),i.addClass("mcs-is-ordering"),c.update_notifications("reorder","warning"),a(".hndle",i).each(function(){a(this).prepend(f.clone())}),a(".mcs-block-click").on("click",c.block_click),d.text("Save Order").addClass("mcs-save-order button-primary").removeClass("mcs-section-reorder"),e.each(function(){a(this).addClass("closed")}),j.sortable({update:c.save_section_order_sortable})},update_notifications:function(a,b){k.removeClass("notice-info notice-warning notice-success").addClass("notice-"+b).find("p").text(mcs_data.strings[a]),k.is(":visible")||k.css({opacity:0}).show(),k.fadeIn("fast")},save_section_order_sortable:function(b,d){var e=a(".mcs-reorder-spinner"),f=[];e.addClass("is-active"),a(".multiple-content-sections-postbox",j).each(function(){f.push(a(this).attr("data-mcs-section-id"))}),response=c.save_section_ajax(f,e)},save_section_order:function(b){b.preventDefault(),b.stopPropagation();var d=a(this),e=(a(".multiple-content-sections-postbox",j),a(".mcs-reorder-spinner")),f=[];e.addClass("is-active"),h.removeClass("disabled"),g.removeClass("disabled"),d.text("Reorder").addClass("mcs-section-reorder").removeClass("mcs-save-order button-primary"),a(".multiple-content-sections-postbox",j).each(function(){f.push(a(this).attr("data-mcs-section-id"))}),a(".mcs-block-click").remove(),k.is(":visible")&&k.removeClass("notice-warning").addClass("notice-info").find("p").text(mcs_data.strings.description),c.save_section_ajax(f,e),j.sortable("destroy")},save_section_ajax:function(b,c){a.post(ajaxurl,{action:"mcs_update_order",mcs_post_id:parseInt(mcs_data.post_id),mcs_section_ids:b,mcs_reorder_section_nonce:mcs_data.reorder_section_nonce},function(a){c.removeClass("is-active")})},change_section_title:function(b){var c=a(this),d=c.val(),e=c.parents(".multiple-content-sections-postbox");(""===d||"undefined"==d)&&(d=mcs_data.strings.default_title),e.find(".handle-title").text(d)},block_click:function(a){a.stopImmediatePropagation()},remove_background:function(b){b.preventDefault(),b.stopPropagation();var c=a(this),d=c.parents(".multiple-content-sections-postbox"),e=parseInt(d.attr("data-mcs-section-id")),f=(c.attr("data-mcs-section-featured-image"),a('<span class="dashicons dashicons-format-image" />'));a.post(ajaxurl,{action:"mcs_update_featured_image",mcs_section_id:parseInt(e),mcs_featured_image_nonce:mcs_data.featured_image_nonce},function(a){-1!=a&&(c.prev().text(mcs_data.strings.add_image).prepend(f),c.remove())})},choose_background:function(b){b.preventDefault(),b.stopPropagation();var c=a(this),d=c.parents(".multiple-content-sections-postbox"),e=parseInt(d.attr("data-mcs-section-id")),f="mcs-background-select-"+e,g=c.attr("data-mcs-section-featured-image");return l[f]?(l[f].uploader.uploader.param("mcs_upload","true"),void l[f].open()):(l[f]=wp.media.frames.media_frames=wp.media({className:"media-frame mcs-media-frame",frame:"select",multiple:!1,title:mcs_data.strings.select_section_bg,button:{text:mcs_data.strings.select_bg}}),l[f].on("open",function(){var a=l[f].state().get("selection");a.add(wp.media.attachment(g))}),l[f].on("select",function(){var b=l[f].state().get("selection").first().toJSON(),d=a("<span />",{"class":"dashicons dashicons-edit"}),h=a("<span />",{"class":"dashicons dashicons-trash"}),i=a("<a/>",{"data-mcs-section-featured-image":"",href:"#","class":"mcs-featured-image-trash"}).text(mcs_data.strings.remove_image).prepend(h);a.post(ajaxurl,{action:"mcs_update_featured_image",mcs_section_id:parseInt(e),mcs_image_id:parseInt(b.id),mcs_featured_image_nonce:mcs_data.featured_image_nonce},function(a){-1!=a&&(g=b.id,c.text(b.title).attr("data-mcs-section-featured-image",parseInt(b.id)).append(d).after(i))})}),void l[f].open())}}}(jQuery),jQuery(function(a){multiple_content_sections.admin.init()});